<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OnlyHaswer Radio â€” Player Pro</title>
<style>
Â  :root{
Â  Â  --bg:#060606; --card:#0e0e0e; --accent:#00ff66; --muted:#9aa79a; --text:#e6ffe9;
Â  }
Â  [data-theme="light"]{ --bg:#f6f7f8; --card:#ffffff; --accent:#008f3a; --muted:#556; --text:#111; }
Â  *{box-sizing:border-box}
Â  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:28px;}
Â  .wrap{width:100%;max-width:1100px;}
Â  header.appHeader{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
Â  header.appHeader img{height:56px;border-radius:10px;box-shadow:0 6px 18px rgba(0,255,102,.06);}
Â  header.appHeader h1{font-size:20px;margin:0;color:var(--accent);font-weight:700;}
Â  .layout{display:grid;grid-template-columns:1fr 320px;gap:20px;}
Â  @media (max-width:980px){ .layout{grid-template-columns:1fr; } header.appHeader{justify-content:center;} }

Â  /* PLAYER CARD */
Â  .playerCard{background:var(--card);padding:20px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6);border:1px solid rgba(0,255,102,.06);}
Â  .playerTop{display:flex;gap:14px;align-items:center;}
Â  .logoSmall{width:92px;height:92px;border-radius:12px;object-fit:cover;box-shadow:0 8px 30px rgba(0,255,102,.05);}
Â  .metaBlock{flex:1;text-align:left;}
Â  .stationTitle{color:var(--accent);font-weight:700;font-size:18px;margin-bottom:6px;}
Â  .stationStatus{font-size:13px;color:var(--muted);}

Â  /* Play button */
Â  .playBtnWrap{display:flex;align-items:center;gap:14px;margin-top:12px;}
Â  .playBtn{
Â  Â  width:86px;height:86px;border-radius:50%;border:none;background:linear-gradient(180deg,#00ff66,#00dd55);color:#000;font-size:26px;
Â  Â  box-shadow:0 8px 30px rgba(0,255,102,.18), inset 0 -6px 20px rgba(0,0,0,.12);cursor:pointer;
Â  }
Â  .playInfo{font-size:14px;color:var(--muted);}

Â  /* Controls row */
Â  .controlsRow{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;}
Â  .controlSmall{background:transparent;border:1px solid rgba(0,255,102,.12);color:var(--accent);padding:8px 10px;border-radius:8px;cursor:pointer;}
Â  .volume{width:150px;}

Â  .shareBtns{display:flex;gap:8px;margin-left:auto;}
Â  .shareBtn{background:transparent;border:1px solid rgba(0,255,102,.08);color:var(--accent);padding:6px 8px;border-radius:8px;cursor:pointer;font-size:14px;}

Â  /* Visualizer (AJUSTADO: Oculto por defecto para que no se vea estÃ¡tico) */
Â  .visualizer{
Â  Â  display:flex;
Â  Â  gap:6px;
Â  Â  align-items:flex-end;
Â  Â  height:52px;
Â  Â  margin-top:18px;
    display: none; 
Â  }
Â  .visualizer.active{
    display: flex; 
Â  }
Â  .visualizer div{width:6px;background:var(--accent);border-radius:4px;opacity:.25;transform-origin:bottom;transition:height .06s linear;}

Â  /* listeners */
Â  .listeners{margin-top:12px;font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center;}
Â  .listenerDot{width:9px;height:9px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px rgba(0,255,102,.25);}

Â  .externalBtn{display:inline-block;margin-top:10px;background:transparent;border:1px solid rgba(0,255,102,.12);padding:8px 10px;border-radius:8px;color:var(--accent);text-decoration:none;}
Â  .smallNote{font-size:12px;color:var(--muted);margin-top:10px;}

Â  /* SIDEBAR */
Â  .sideCard{background:var(--card);padding:14px;border-radius:12px;}
Â  .chatMini iframe{width:100%;height:260px;border-radius:8px;border:0;background:transparent;}
Â  .infoList{margin-top:12px;font-size:14px;color:var(--muted);line-height:1.45;}

Â  .themeToggle{border:1px solid rgba(0,255,102,.08);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--accent);background:transparent;}

Â  /* small responsive tweaks */
Â  @media (max-width:520px){
Â  Â  .playBtn{width:72px;height:72px;font-size:22px}
Â  Â  .volume{width:110px}
Â  Â  header.appHeader img{height:48px}
Â  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body data-theme="dark">
Â  <div class="wrap">
Â  Â  <header class="appHeader">
Â  Â  Â  <img src="onlyhaswer2.png" alt="OnlyHaswer logo" />
Â  Â  Â  <h1>OnlyHaswer Radio â€” En vivo</h1>
Â  Â  Â  <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
Â  Â  Â  Â  <button id="themeToggle" class="themeToggle" title="Cambiar tema">ðŸŒ— Tema</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="layout">
Â  Â  Â  Â  Â  Â  <div class="playerCard" id="mainPlayer">
Â  Â  Â  Â  <div class="playerTop">
Â  Â  Â  Â  Â  <img class="logoSmall" src="onlyhaswer2.png" alt="logo">
Â  Â  Â  Â  Â  <div class="metaBlock">
Â  Â  Â  Â  Â  Â  <div class="stationTitle">OnlyHaswer Radio</div>
Â  Â  Â  Â  Â  Â  <div class="stationStatus" id="stationStatus">Conectandoâ€¦</div>

Â  Â  Â  Â  Â  Â  <div class="playBtnWrap">
Â  Â  Â  Â  Â  Â  Â  <button id="playBtn" class="playBtn" aria-label="Play">â–¶</button>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="playInfo" id="playLabel">Presiona para escuchar</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:6px;color:var(--muted);font-size:13px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Stream: <span style="font-family:monospace;font-size:12px;color:#bfffc9">live.mp3</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="controlsRow">
Â  Â  Â  Â  Â  Â  Â  <button id="muteBtn" class="controlSmall" title="Silenciar">ðŸ”ˆ</button>
Â  Â  Â  Â  Â  Â  Â  <input id="volRange" class="volume" type="range" min="0" max="1" step="0.01" value="0.9">
Â  Â  Â  Â  Â  Â  Â  <div class="shareBtns">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="shareWhats" class="shareBtn" title="Compartir por WhatsApp">WA</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="shareFb" class="shareBtn" title="Compartir en Facebook">FB</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="shareTw" class="shareBtn" title="Compartir en Twitter">TW</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="visualizer" id="viz">
Â  Â  Â  Â  Â  Â  Â  <div style="height:8px"></div><div style="height:8px"></div><div style="height:8px"></div>
Â  Â  Â  Â  Â  Â  Â  <div style="height:8px"></div><div style="height:8px"></div><div style="height:8px"></div>
Â  Â  Â  Â  Â  Â  Â  <div style="height:8px"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="listeners" id="listenersLine">
Â  Â  Â  Â  Â  Â  Â  <div class="listenerDot"></div>
Â  Â  Â  Â  Â  Â  Â  <div id="listenersCount">Oyentes: â€”</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <a id="externalOpen" class="externalBtn" href="https://uk26freenew.listen2myradio.com/live.mp3?typeportmount=ice_5838_stream_53056691" target="_blank" rel="noopener noreferrer">
Â  Â  Â  Â  Â  Â  Â  Abrir en reproductor externo (VLC/Winamp)
Â  Â  Â  Â  Â  Â  </a>

Â  Â  Â  Â  Â  Â  <div class="smallNote" style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  Â  Nota: el problema de reproducciÃ³n ha sido corregido con Howler.js.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <aside>
Â  Â  Â  Â  <div class="sideCard">
Â  Â  Â  Â  Â  <div style="font-weight:700;color:var(--accent);margin-bottom:8px;">Chat</div>
Â  Â  Â  Â  Â  <div class="chatMini">
Â  Â  Â  Â  Â  Â  <iframe src="https://xat.com/embed/chat.php#id=5&gn=OnlyHaswerRadio" title="Chat OnlyHaswer"></iframe>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="margin-top:12px;font-weight:700;color:var(--accent);">InformaciÃ³n</div>
Â  Â  Â  Â  Â  <div class="infoList">
Â  Â  Â  Â  Â  Â  <div id="metaNow">Estado: recibiendo stream...</div>
Â  Â  Â  Â  Â  Â  <div id="metaSong" style="margin-top:6px;color:var(--muted);font-weight:600">Now Playing: â€”</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  Â  <button id="copyStream" class="controlSmall">Copiar URL del stream</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:10px;font-size:13px;color:var(--muted);">
Â  Â  Â  Â  Â  Â  Â  Botones: compartir, abrir en VLC/Winamp, ver oyentes.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </aside>
Â  Â  </div>
Â  </div>

<script>
/* CONFIG */
const STREAM_URL = "https://uk26freenew.listen2myradio.com/live.mp3?typeportmount=ice_5838_stream_53056691";
const METADATA_URL = "http://onlyhaswerradio.ddns.net:8000/status-json.xsl"; // Icecast status JSON via your DDNS
const POLL_INTERVAL = 7000; // ms

/* ELEMENTS */
// const audio = document.getElementById('hiddenAudio'); // YA NO SE USA
const playBtn = document.getElementById('playBtn');
const playLabel = document.getElementById('playLabel');
const stationStatus = document.getElementById('stationStatus');
const listenersCount = document.getElementById('listenersCount');
const viz = document.getElementById('viz');
const volRange = document.getElementById('volRange');
const muteBtn = document.getElementById('muteBtn');
const metaSong = document.getElementById('metaSong');
const metaNow = document.getElementById('metaNow');
const copyBtn = document.getElementById('copyStream');
const themeToggle = document.getElementById('themeToggle');

let isPlaying = false; // Se mantiene, ahora basado en Howler.js

/* PASO 3: INICIALIZACIÃ“N DEL REPRODUCTOR HOWLER.JS */
const sound = new Howl({
Â  src: [STREAM_URL],
Â  html5: true, // Forzar uso de elemento de audio nativo para streaming
Â  volume: parseFloat(volRange.value),
Â  preload: false,
  format: ['mp3'], // Ayuda a la compatibilidad
Â  onplay: () => {
    // Actualizar el estado visual inmediatamente cuando Howler comienza a reproducir
    isPlaying = true;
    playBtn.textContent = "â¸";
    playLabel.textContent = "Reproduciendo";
    stationStatus.textContent = "Conectado";
    viz.classList.add('active'); 
    startVisualizer();
  },
Â  onpause: () => {
    isPlaying = false;
    playBtn.textContent = "â–¶";
    playLabel.textContent = "Pausado";
    stationStatus.textContent = "Pausado";
    viz.classList.remove('active'); 
    stopVisualizer();
  },
Â  onloaderror: (id, error) => {
    console.error("Howler Load Error:", error);
    stationStatus.textContent = "Error de carga del stream.";
  },
Â  onend: () => {
    // Si el stream termina (generalmente no pasa en radio), reinicia el estado
    playBtn.textContent = "â–¶";
    playLabel.textContent = "Detenido";
    stationStatus.textContent = "Desconectado";
    viz.classList.remove('active'); 
    stopVisualizer();
  }
});


/* PLAY / PAUSE - AHORA USA HOWLER.JS */
playBtn.addEventListener('click', () => {
Â  try {
Â  Â  if (sound.playing()) {
Â  Â  Â  sound.pause();
Â  Â  } else {
      // Intenta cargar si no estÃ¡ cargado, y luego reproduce
      if(sound.state() !== 'loaded') {
          sound.load();
          sound.once('load', () => sound.play());
      } else {
          sound.play();
      }
Â  Â  }
Â  } catch (err) {
Â  Â  console.warn("Play error:", err);
Â  Â  stationStatus.textContent = "Error al intentar reproducir.";
Â  }
});

/* VOLUME / MUTE - AHORA USA HOWLER.JS */
volRange.addEventListener('input', (e)=> sound.volume(e.target.value));
muteBtn.addEventListener('click', ()=> {
Â  sound.mute(!sound.mute());
Â  muteBtn.textContent = sound.mute() ? "ðŸ”‡" : "ðŸ”ˆ";
});

/* RESTO DEL CÃ“DIGO (Metadata, Visualizer, etc.) */

/* COPY STREAM */
copyBtn.addEventListener('click', async ()=>{
Â  try {
Â  Â  await navigator.clipboard.writeText(STREAM_URL);
Â  Â  copyBtn.textContent = "Copiado âœ“";
Â  Â  setTimeout(()=> copyBtn.textContent = "Copiar URL del stream", 1600);
Â  } catch {
Â  Â  copyBtn.textContent = "Error";
Â  Â  setTimeout(()=> copyBtn.textContent = "Copiar URL del stream", 1600);
Â  }
});

/* SHARE BUTTONS */
const pageURL = encodeURIComponent(window.location.href);
document.getElementById('shareWhats').addEventListener('click', ()=> {
Â  const u = encodeURIComponent(STREAM_URL);
Â  window.open(`https://api.whatsapp.com/send?text=Estoy escuchando OnlyHaswer Radio: ${u}`, '_blank');
});
document.getElementById('shareFb').addEventListener('click', ()=> {
Â  window.open(`https://www.facebook.com/sharer/sharer.php?u=${pageURL}`, '_blank');
});
document.getElementById('shareTw').addEventListener('click', ()=> {
Â  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("EscuchÃ¡ OnlyHaswer Radio")}&url=${pageURL}`, '_blank');
});

/* THEME TOGGLE */
function setTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('oh_theme', t); }
themeToggle.addEventListener('click', ()=> { const cur = document.body.getAttribute('data-theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); });
(function initTheme(){ const saved = localStorage.getItem('oh_theme'); if(saved) setTheme(saved); })();

/* VISUALIZER (WebAudio) - REQUIERE EL ELEMENTO <audio> INTERNO DE HOWLER */
let audioCtx, analyser, sourceNode, rafId;

// FunciÃ³n para obtener el elemento <audio> nativo que Howler estÃ¡ usando
function getHowlerAudioElement() {
    // Howler.js usa un array de sonidos. Tomamos el primero.
    const hAudio = sound._webAudio ? sound._sounds[0]._node : null;
    return hAudio ? hAudio.mediaElement : null;
}

function startVisualizer(){
    const nativeAudio = getHowlerAudioElement();
    if (!nativeAudio || analyser) return; 

    try {
        // Inicializar AudioContext si no existe
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } else if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 128;

        // Crear SourceNode solo una vez y conectarlo
        if(!sourceNode) { 
            sourceNode = audioCtx.createMediaElementSource(nativeAudio);
            sourceNode.connect(analyser);
            analyser.connect(audioCtx.destination);
        }
        renderViz();
    } catch(e){
        console.warn("Visualizer not available (CORS):", e);
        viz.classList.remove('active'); 
    }
}

function stopVisualizer(){
Â  if(!analyser) return;
Â  if(rafId) cancelAnimationFrame(rafId);
Â  rafId = null; 
Â  const bars = viz.querySelectorAll('div'); bars.forEach(b=> b.style.height='8px');
}

function renderViz(){
Â  if(!analyser || !isPlaying) return;
Â  const bufferLength = analyser.frequencyBinCount;
Â  const data = new Uint8Array(bufferLength);
Â  const bars = viz.querySelectorAll('div');
Â  function draw(){
Â  Â  rafId = requestAnimationFrame(draw);
Â  Â  analyser.getByteFrequencyData(data);
Â  Â  for(let i=0;i<bars.length;i++){
Â  Â  Â  const v = data[i] || 8;
Â  Â  Â  const h = Math.max(8, Math.min(52, Math.round((v / 255) * 52)));
Â  Â  Â  bars[i].style.height = h + 'px';
Â  Â  Â  bars[i].style.opacity = (0.25 + (v/255)*0.75).toString();
Â  Â  }
Â  }
Â  draw();
}

/* METADATA & LISTENERS (cÃ³digo intacto - sigue fallando por HTTP/HTTPS) */
async function fetchStatusJson(){
Â  try {
Â  Â  const res = await fetch(METADATA_URL, {mode:'cors'});
Â  Â  if(!res.ok) throw new Error('no-ok');
Â  Â  const text = await res.text();
Â  Â  let json;
Â  Â  try { json = JSON.parse(text); } catch(e){
Â  Â  Â  const jMatch = text.match(/\{[\s\S]*\}/);
Â  Â  Â  if(jMatch) json = JSON.parse(jMatch[0]);
Â  Â  }
Â  Â  if(json && json.icestats){
Â  Â  Â  const src = json.icestats.source;
Â  Â  Â  let mount = src;
Â  Â  Â  if(Array.isArray(src)){ mount = src.find(s => (s.listenurl && s.listenurl.includes('/stream')) || s.listenurl) || src[0]; }
Â  Â  Â  const title = (mount && (mount.title || mount.song)) || null;
Â  Â  Â  const listeners = mount && (mount.listeners || mount.currentlisteners || mount.streams);
Â  Â  Â  if(title) metaSong.textContent = "Now Playing: " + title;
Â  Â  Â  if(listeners !== undefined) listenersCount.textContent = "Oyentes: " + listeners;
Â  Â  Â  metaNow.textContent = "Conectado (datos pÃºblicos)";
Â  Â  Â  stationStatus.textContent = "Conectado";
Â  Â  Â  return true;
Â  Â  } else { throw new Error('no-json'); }
Â  } catch(err){ console.debug("fetchStatusJson failed:", err); return false; }
}

async function fetch7Html(url){
Â  try {
Â  Â  const res = await fetch(url, {mode:'cors'});
Â  Â  if(!res.ok) throw new Error('no-ok');
Â  Â  const txt = await res.text();
Â  Â  let m = txt.match(/Current Song:\s*<[^>]*>([^<]+)/i) || txt.match(/Currently Playing:\s*([^<\r\n]+)/i) || txt.match(/Stream Title:\s*([^<\r\n]+)/i);
Â  Â  if(m && m[1]){
Â  Â  Â  metaSong.textContent = "Now Playing: " + m[1].trim();
Â  Â  Â  metaNow.textContent = "Conectado (datos pÃºblicos)";
Â  Â  Â  return true;
Â  Â  }
Â  } catch(e){ console.debug("fetch7Html failed", e); }
Â  return false;
}

async function tryFetchMetadata(){
Â  const ok = await fetchStatusJson();
Â  if(ok) return;
Â  const candidates = [
Â  Â  METADATA_URL.replace('/status-json.xsl','/status.xsl'),
Â  Â  METADATA_URL.replace('/status-json.xsl','/7.html'),
Â  Â  METADATA_URL.replace('/status-json.xsl','/status'),
Â  ];
Â  for(const c of candidates){ const r = await fetch7Html(c); if(r) return; }
Â  metaNow.textContent = "Metadata no disponible pÃºblicamente (CORS / endpoint)";
Â  listenersCount.textContent = "Oyentes: â€”";
}

tryFetchMetadata();
setInterval(tryFetchMetadata, POLL_INTERVAL);

metaNow.textContent = "Intentando cargar metadataâ€¦";
metaSong.textContent = "Now Playing: â€”";

/* EXTERNAL OPEN - tries to open stream in external player (user agent handles) */
document.getElementById('externalOpen').addEventListener('click', (e) => {
Â  // opens the raw stream URL in a new tab where user can choose 'open with' in system
});

/* small safety: stop audio when page hidden */
document.addEventListener('visibilitychange', ()=> {
Â  if(document.hidden && isPlaying){ 
    sound.pause(); 
}
});
</script>

</body>
</html>

  /* Controls row */
  .controlsRow{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;}
  .controlSmall{background:transparent;border:1px solid rgba(0,255,102,.12);color:var(--accent);padding:8px 10px;border-radius:8px;cursor:pointer;}
  .volume{width:150px;}

  .shareBtns{display:flex;gap:8px;margin-left:auto;}
  .shareBtn{background:transparent;border:1px solid rgba(0,255,102,.08);color:var(--accent);padding:6px 8px;border-radius:8px;cursor:pointer;font-size:14px;}

  /* Visualizer */
  .visualizer{display:flex;gap:6px;align-items:flex-end;height:52px;margin-top:18px;}
  .visualizer div{width:6px;background:var(--accent);border-radius:4px;opacity:.25;transform-origin:bottom;transition:height .06s linear;}

  /* listeners */
  .listeners{margin-top:12px;font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center;}
  .listenerDot{width:9px;height:9px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px rgba(0,255,102,.25);}

  .externalBtn{display:inline-block;margin-top:10px;background:transparent;border:1px solid rgba(0,255,102,.12);padding:8px 10px;border-radius:8px;color:var(--accent);text-decoration:none;}
  .smallNote{font-size:12px;color:var(--muted);margin-top:10px;}

  /* SIDEBAR */
  .sideCard{background:var(--card);padding:14px;border-radius:12px;}
  .chatMini iframe{width:100%;height:260px;border-radius:8px;border:0;background:transparent;}
  .infoList{margin-top:12px;font-size:14px;color:var(--muted);line-height:1.45;}

  .themeToggle{border:1px solid rgba(0,255,102,.08);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--accent);background:transparent;}

  /* small responsive tweaks */
  @media (max-width:520px){
    .playBtn{width:72px;height:72px;font-size:22px}
    .volume{width:110px}
    header.appHeader img{height:48px}
  }
</style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header class="appHeader">
      <img src="onlyhaswer2.png" alt="OnlyHaswer logo" />
      <h1>OnlyHaswer Radio â€” En vivo</h1>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <button id="themeToggle" class="themeToggle" title="Cambiar tema">ðŸŒ— Tema</button>
      </div>
    </header>

    <div class="layout">
      <!-- MAIN PLAYER -->
      <div class="playerCard" id="mainPlayer">
        <div class="playerTop">
          <img class="logoSmall" src="onlyhaswer2.png" alt="logo">
          <div class="metaBlock">
            <div class="stationTitle">OnlyHaswer Radio</div>
            <div class="stationStatus" id="stationStatus">Conectandoâ€¦</div>

            <div class="playBtnWrap">
              <button id="playBtn" class="playBtn" aria-label="Play">â–¶</button>
              <div>
                <div class="playInfo" id="playLabel">Presiona para escuchar</div>
                <div style="margin-top:6px;color:var(--muted);font-size:13px;">
                  Stream: <span style="font-family:monospace;font-size:12px;color:#bfffc9">live.mp3</span>
                </div>
              </div>
            </div>

            <div class="controlsRow">
              <button id="muteBtn" class="controlSmall" title="Silenciar">ðŸ”ˆ</button>
              <input id="volRange" class="volume" type="range" min="0" max="1" step="0.01" value="0.9">
              <div class="shareBtns">
                <button id="shareWhats" class="shareBtn" title="Compartir por WhatsApp">WA</button>
                <button id="shareFb" class="shareBtn" title="Compartir en Facebook">FB</button>
                <button id="shareTw" class="shareBtn" title="Compartir en Twitter">TW</button>
              </div>
            </div>

            <div class="visualizer" id="viz">
              <div style="height:8px"></div><div style="height:8px"></div><div style="height:8px"></div>
              <div style="height:8px"></div><div style="height:8px"></div><div style="height:8px"></div>
              <div style="height:8px"></div>
            </div>

            <div class="listeners" id="listenersLine">
              <div class="listenerDot"></div>
              <div id="listenersCount">Oyentes: â€”</div>
            </div>

            <a id="externalOpen" class="externalBtn" href="https://uk26freenew.listen2myradio.com/live.mp3?typeportmount=ice_5838_stream_53056691" target="_blank" rel="noopener noreferrer">
              Abrir en reproductor externo (VLC/Winamp)
            </a>

            <div class="smallNote" style="margin-top:8px;">
              Nota: si el stream no arranca, presiona Play manualmente (polÃ­ticas de autoplay del navegador).
            </div>
          </div>
        </div>
      </div>

      <!-- SIDEBAR CHAT + INFO -->
      <aside>
        <div class="sideCard">
          <div style="font-weight:700;color:var(--accent);margin-bottom:8px;">Chat</div>
          <div class="chatMini">
            <iframe src="https://xat.com/embed/chat.php#id=5&gn=OnlyHaswerRadio" title="Chat OnlyHaswer"></iframe>
          </div>

          <div style="margin-top:12px;font-weight:700;color:var(--accent);">InformaciÃ³n</div>
          <div class="infoList">
            <div id="metaNow">Estado: recibiendo stream...</div>
            <div id="metaSong" style="margin-top:6px;color:var(--muted);font-weight:600">Now Playing: â€”</div>
            <div style="margin-top:8px;">
              <button id="copyStream" class="controlSmall">Copiar URL del stream</button>
            </div>
            <div style="margin-top:10px;font-size:13px;color:var(--muted);">
              Botones: compartir, abrir en VLC/Winamp, ver oyentes (si el servidor lo permite).
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- audio element (hidden visually) -->
  <audio id="hiddenAudio" preload="none" src="https://uk26freenew.listen2myradio.com/live.mp3?typeportmount=ice_5838_stream_53056691" style="display:none"></audio>

<script>
/* CONFIG */
const STREAM_URL = "https://uk26freenew.listen2myradio.com/live.mp3?typeportmount=ice_5838_stream_53056691";
const METADATA_URL = "http://onlyhaswerradio.ddns.net:8000/status-json.xsl"; // Icecast status JSON via your DDNS
const POLL_INTERVAL = 7000; // ms

/* ELEMENTS */
const audio = document.getElementById('hiddenAudio');
const playBtn = document.getElementById('playBtn');
const playLabel = document.getElementById('playLabel');
const stationStatus = document.getElementById('stationStatus');
const listenersCount = document.getElementById('listenersCount');
const viz = document.getElementById('viz');
const volRange = document.getElementById('volRange');
const muteBtn = document.getElementById('muteBtn');
const metaSong = document.getElementById('metaSong');
const metaNow = document.getElementById('metaNow');
const copyBtn = document.getElementById('copyStream');
const themeToggle = document.getElementById('themeToggle');

let audioCtx, analyser, sourceNode, rafId;
let isPlaying = false;

/* PLAY / PAUSE */
playBtn.addEventListener('click', async () => {
  try {
    if (audio.paused) {
      await audio.play();
      isPlaying = true;
      playBtn.textContent = "â¸";
      playLabel.textContent = "Reproduciendo";
      stationStatus.textContent = "Conectado";
      viz.style.opacity = 1;
      startVisualizer();
    } else {
      audio.pause();
      isPlaying = false;
      playBtn.textContent = "â–¶";
      playLabel.textContent = "Pausado";
      stationStatus.textContent = "Pausado";
      viz.style.opacity = 0.45;
      stopVisualizer();
    }
  } catch (err) {
    console.warn("Play error:", err);
    stationStatus.textContent = "Error al reproducir (clic manual requerido)";
  }
});

/* VOLUME / MUTE */
audio.volume = parseFloat(volRange.value);
volRange.addEventListener('input', (e)=> audio.volume = e.target.value);
muteBtn.addEventListener('click', ()=> {
  audio.muted = !audio.muted;
  muteBtn.textContent = audio.muted ? "ðŸ”‡" : "ðŸ”ˆ";
});

/* COPY STREAM */
copyBtn.addEventListener('click', async ()=>{
  try {
    await navigator.clipboard.writeText(STREAM_URL);
    copyBtn.textContent = "Copiado âœ“";
    setTimeout(()=> copyBtn.textContent = "Copiar URL del stream", 1600);
  } catch {
    copyBtn.textContent = "Error";
    setTimeout(()=> copyBtn.textContent = "Copiar URL del stream", 1600);
  }
});

/* SHARE BUTTONS */
const pageURL = encodeURIComponent(window.location.href);
document.getElementById('shareWhats').addEventListener('click', ()=> {
  const u = encodeURIComponent(STREAM_URL);
  window.open(`https://api.whatsapp.com/send?text=Estoy escuchando OnlyHaswer Radio: ${u}`, '_blank');
});
document.getElementById('shareFb').addEventListener('click', ()=> {
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${pageURL}`, '_blank');
});
document.getElementById('shareTw').addEventListener('click', ()=> {
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("EscuchÃ¡ OnlyHaswer Radio")}&url=${pageURL}`, '_blank');
});

/* THEME TOGGLE */
function setTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('oh_theme', t); }
themeToggle.addEventListener('click', ()=> { const cur = document.body.getAttribute('data-theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); });
(function initTheme(){ const saved = localStorage.getItem('oh_theme'); if(saved) setTheme(saved); })();

/* VISUALIZER (WebAudio) */
function startVisualizer(){
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 128;
    sourceNode = audioCtx.createMediaElementSource(audio);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    renderViz();
  } catch(e){
    console.warn("Visualizer not available:", e);
  }
}
function stopVisualizer(){
  if(!audioCtx) return;
  if(rafId) cancelAnimationFrame(rafId);
  try { analyser.disconnect(); sourceNode.disconnect(); audioCtx.close(); } catch(e){}
  audioCtx = null; analyser = null; sourceNode = null; rafId = null;
  const bars = viz.querySelectorAll('div'); bars.forEach(b=> b.style.height='8px');
}
function renderViz(){
  if(!analyser) return;
  const bufferLength = analyser.frequencyBinCount;
  const data = new Uint8Array(bufferLength);
  const bars = viz.querySelectorAll('div');
  function draw(){
    rafId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    for(let i=0;i<bars.length;i++){
      const v = data[i] || 8;
      const h = Math.max(8, Math.min(52, Math.round((v / 255) * 52)));
      bars[i].style.height = h + 'px';
      bars[i].style.opacity = (0.25 + (v/255)*0.75).toString();
    }
  }
  draw();
}

/* METADATA & LISTENERS (graceful fallback if CORS) */
async function fetchStatusJson(){
  try {
    const res = await fetch(METADATA_URL, {mode:'cors'});
    if(!res.ok) throw new Error('no-ok');
    const text = await res.text();
    // try parse JSON embedded or plain JSON
    let json;
    try { json = JSON.parse(text); } catch(e){
      // sometimes status.xsl returns HTML/XML -> try to extract JSON-like
      const jMatch = text.match(/\{[\s\S]*\}/);
      if(jMatch) json = JSON.parse(jMatch[0]);
    }
    if(json && json.icestats){
      const src = json.icestats.source;
      let mount = src;
      if(Array.isArray(src)){
        // find the mount that matches '/stream' or has listenurl
        mount = src.find(s => (s.listenurl && s.listenurl.includes('/stream')) || s.listenurl) || src[0];
      }
      const title = (mount && (mount.title || mount.song)) || null;
      const listeners = mount && (mount.listeners || mount.currentlisteners || mount.streams);
      if(title) metaSong.textContent = "Now Playing: " + title;
      if(listeners !== undefined) listenersCount.textContent = "Oyentes: " + listeners;
      metaNow.textContent = "Conectado (datos pÃºblicos)";
      stationStatus.textContent = "Conectado";
      return true;
    } else {
      throw new Error('no-json');
    }
  } catch(err){
    console.debug("fetchStatusJson failed:", err);
    return false;
  }
}

/* fallback: try parse common HTML endpoints (7.html) */
async function fetch7Html(url){
  try {
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('no-ok');
    const txt = await res.text();
    // parse simple patterns
    let m = txt.match(/Current Song:\s*<[^>]*>([^<]+)/i) || txt.match(/Currently Playing:\s*([^<\r\n]+)/i) || txt.match(/Stream Title:\s*([^<\r\n]+)/i);
    if(m && m[1]){
      metaSong.textContent = "Now Playing: " + m[1].trim();
      metaNow.textContent = "Conectado (datos pÃºblicos)";
      return true;
    }
  } catch(e){
    console.debug("fetch7Html failed", e);
  }
  return false;
}

/* Try endpoints in order */
async function tryFetchMetadata(){
  // Quick optimistic fetch to METADATA_URL (status-json.xsl)
  const ok = await fetchStatusJson();
  if(ok) return;
  // try variations
  const candidates = [
    METADATA_URL.replace('/status-json.xsl','/status.xsl'),
    METADATA_URL.replace('/status-json.xsl','/7.html'),
    METADATA_URL.replace('/status-json.xsl','/status'),
  ];
  for(const c of candidates){
    const r = await fetch7Html(c);
    if(r) return;
  }
  // if none worked:
  metaNow.textContent = "Metadata no disponible pÃºblicamente (CORS / endpoint)";
  listenersCount.textContent = "Oyentes: â€”";
}

/* periodic polling */
tryFetchMetadata();
setInterval(tryFetchMetadata, POLL_INTERVAL);

/* initial UI */
metaNow.textContent = "Intentando cargar metadataâ€¦";
metaSong.textContent = "Now Playing: â€”";

/* EXTERNAL OPEN - tries to open stream in external player (user agent handles) */
document.getElementById('externalOpen').addEventListener('click', (e) => {
  // opens the raw stream URL in a new tab where user can choose 'open with' in system
});

/* small safety: stop audio when page hidden */
document.addEventListener('visibilitychange', ()=> {
  if(document.hidden && isPlaying){ audio.pause(); playBtn.textContent="â–¶"; playLabel.textContent="Pausado"; isPlaying=false; stopVisualizer(); }
});
</script>

</body>
</html>

